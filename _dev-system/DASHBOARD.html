<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Architectural Ledger</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg: #000000;
            --surface: #0a0a0a;
            --border: #1a1a1a;
            --text-main: #ffffff;
            --text-dim: #555555;
            --accent: #ffffff;
            --critical: #ff3b30;
            /* Only color preserved for safety */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            outline: none;
        }

        body {
            background: var(--bg);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            height: 100vh;
        }

        .app {
            display: grid;
            grid-template-rows: 80px 1fr;
            height: 100vh;
            padding: 0 3rem;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            font-size: 0.9rem;
            font-weight: 700;
            letter-spacing: 0.2rem;
            text-transform: uppercase;
        }

        .system-status {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            color: var(--text-dim);
        }

        .main-layout {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 4rem;
            overflow: hidden;
            padding: 3rem 0;
        }

        /* Left: Summaries */
        .summary-panel {
            display: flex;
            flex-direction: column;
            gap: 4rem;
        }

        .metric-group {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
        }

        .metric-lab {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-dim);
            font-weight: 600;
        }

        .metric-val {
            font-size: 2rem;
            font-weight: 400;
        }

        .metric-val.critical {
            color: var(--critical);
            font-weight: 700;
        }

        .chart-section {
            border-top: 1px solid var(--border);
            padding-top: 3rem;
        }

        .chart-container {
            width: 100%;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .chart-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 9px;
            fill: var(--text-dim);
        }

        /* Right: Ledger/Task Table */
        .ledger-panel {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .search-area {
            margin-bottom: 2rem;
        }

        #searchInput {
            width: 100%;
            background: transparent;
            border: none;
            border-bottom: 1px solid var(--border);
            padding: 1rem 0;
            color: #fff;
            font-size: 1.2rem;
            transition: border-color 0.3s;
        }

        #searchInput:focus {
            border-color: #555;
        }

        .ledger-scroll {
            flex: 1;
            overflow-y: auto;
            padding-right: 1rem;
        }

        .ledger-row {
            display: grid;
            grid-template-columns: 120px 1fr 100px;
            padding: 1.2rem 0;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: opacity 0.2s;
            align-items: baseline;
        }

        .ledger-row:hover {
            opacity: 0.6;
        }

        .row-type {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            font-weight: 500;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        .row-file {
            font-size: 0.95rem;
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding-right: 2rem;
        }

        .row-meta {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-dim);
            text-align: right;
        }

        .row-critical .row-type {
            color: var(--critical);
        }

        .row-critical .row-file {
            color: var(--critical);
            font-weight: 700;
        }

        /* Tooltip */
        #tooltip {
            position: fixed;
            background: #111;
            border: 1px solid #222;
            padding: 1.5rem;
            border-radius: 0.2rem;
            font-size: 0.8rem;
            pointer-events: none;
            opacity: 0;
            z-index: 1000;
            width: 320px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.8);
        }

        ::-webkit-scrollbar {
            width: 2px;
        }

        ::-webkit-scrollbar-thumb {
            background: #222;
        }
    </style>
</head>

<body>
    <div id="tooltip"></div>
    <div class="app">
        <header>
            <div class="logo">Architectural Ledger</div>
            <div class="system-status">SCAN V8.5 // GOVERNANCE_MODE: AGNOSTIC // CLARITY_INDEX: HIGH</div>
        </header>

        <div class="main-layout">
            <!-- Left: Minimal Stats -->
            <div class="summary-panel">
                <div class="metric-group">
                    <div class="metric">
                        <span class="metric-lab">Critical Hotspots</span>
                        <span class="metric-val critical" id="stat-violations">0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-lab">Planned Refactors</span>
                        <span class="metric-val" id="stat-tasks">0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-lab">Total Artifacts</span>
                        <span class="metric-val" id="stat-files">0</span>
                    </div>
                </div>

                <div class="chart-section">
                    <h3 class="metric-lab" style="margin-bottom: 2rem;">Distribution Balance</h3>
                    <div id="type-chart" class="chart-container"></div>
                </div>
            </div>

            <!-- Right: The Ledger -->
            <div class="ledger-panel">
                <div class="search-area">
                    <input type="text" id="searchInput" placeholder="Query ledger entries...">
                </div>
                <div class="ledger-scroll" id="ledger-list">
                    <!-- Data injected here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let fullData = null;
        let query = '';

        async function init() {
            try {
                const res = await fetch('plans/metadata.json');
                fullData = await res.json();
                render();
            } catch (e) {
                if (window.INJECTED_METADATA) {
                    fullData = window.INJECTED_METADATA;
                    render();
                } else {
                    document.body.innerHTML = "<div style='padding:5rem; font-family:monospace;'>[ERR] METADATA_ORPHANED // REQUIRE_LOCAL_SERVER</div>";
                }
            }
        }

        function render() {
            let totalFiles = 0, violations = 0, tasks = 0;
            const typeCounts = { Violation: 0, Surgical: 0, Merge: 0, Structural: 0, Ambiguity: 0 };
            const backlog = [];

            Object.entries(fullData).forEach(([engine, units]) => {
                totalFiles += units.length;
                units.forEach(unit => {
                    const type = Object.keys(unit)[0];
                    const data = unit[type];
                    typeCounts[type]++;
                    if (type === 'Violation') violations++;
                    else tasks++;

                    const fileLabel = data.file ? data.file.split('/').pop() : (data.folder ? data.folder.split('/').pop() : 'Module');
                    backlog.push({ type, engine, data, label: fileLabel });
                });
            });

            document.getElementById('stat-files').innerText = totalFiles;
            document.getElementById('stat-violations').innerText = violations;
            document.getElementById('stat-tasks').innerText = tasks;

            renderPie(Object.entries(typeCounts).map(([name, val]) => ({ name, val })));
            renderLedger(backlog);
        }

        function renderPie(data) {
            const container = d3.select("#type-chart");
            const width = 200, height = 200, radius = 70;
            container.selectAll("*").remove();

            const svg = container.append("svg").attr("width", width).attr("height", height)
                .append("g").attr("transform", `translate(${width / 2},${height / 2})`);

            const pie = d3.pie().value(d => d.val).sort(null);
            const arc = d3.arc().innerRadius(radius * 0.8).outerRadius(radius);

            const g = svg.selectAll(".arc").data(pie(data)).enter().append("g").attr("class", "arc");

            g.append("path").attr("d", arc)
                .attr("fill", d => d.data.name === 'Violation' ? 'var(--critical)' : '#1a1a1a')
                .attr("stroke", "var(--bg)").attr("stroke-width", "2px");

            // Minimalist legend or center text
            svg.append("text").text("DEBT").attr("text-anchor", "middle").attr("dy", "0.3em")
                .attr("fill", "#333").attr("font-size", "10px").attr("font-weight", "800");
        }

        function renderLedger(units) {
            const list = document.getElementById('ledger-list');
            const filtered = units.filter(u => (u.label + (u.data.reason || '')).toLowerCase().includes(query.toLowerCase()));

            list.innerHTML = filtered.map(u => `
                <div class="ledger-row ${u.type === 'Violation' ? 'row-critical' : ''}" 
                     onmouseover="showTooltip(event, '${u.label}', '${(u.data.reason || u.data.pattern || '').replace(/'/g, "\\'")}')" 
                     onmouseout="hideTooltip()">
                    <span class="row-type">${u.type}</span>
                    <span class="row-file">${u.label}</span>
                    <span class="row-meta">${u.engine.toUpperCase()}</span>
                </div>
            `).join('');
        }

        function showTooltip(e, title, reason) {
            const tt = document.getElementById('tooltip');
            tt.innerHTML = `<div style='font-weight:700; margin-bottom:1rem; border-bottom:1px solid #222; padding-bottom:0.5rem;'>${title}</div><div style='color:#888; font-size:0.75rem; line-height:1.6;'>${reason}</div>`;
            tt.style.opacity = 1; tt.style.left = (e.pageX + 20) + "px"; tt.style.top = (e.pageY + 20) + "px";
        }
        function hideTooltip() { document.getElementById('tooltip').style.opacity = 0; }

        document.getElementById('searchInput').oninput = (e) => { query = e.target.value; render(); };

        init();
        window.addEventListener('resize', render);
    </script>
</body>

</html>